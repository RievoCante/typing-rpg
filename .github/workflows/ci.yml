name: CI/CD Pipline

# When to run this workflow
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

# Jobs/Tasks to run
jobs:
  # Job 1: check frontend code
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      # Step 1: Get code from GitHub
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Step 3: Install dependencies
      - name: Install dependencies
        working-directory: ./frontend
        run: bun install

      # Step 4: Run linting
      - name: Run ESLint
        working-directory: ./frontend
        run: bun run lint

      # Step 5: Check formatting
      - name: Check Prettier formatting
        working-directory: ./frontend
        run: bun run format:check

      # Step 6: Type-check TypeScript
      - name: Type check
        working-directory: ./frontend
        run: bunx tsc --noEmit

      # Step 7: build project (ensures it complies)
      - name: Build
        working-directory: ./frontend
        run: bun run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}

  # Job 2: check backend code
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ./backend
        run: bun install

      # Type-check backend (no build step for Workers)
      - name: Type check
        working-directory: ./backend
        run: bunx tsc --noEmit

  # Job 3: Deploy backend to Cloudflare Workers (only on main branch)
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci] # Wait for CI to pass first
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' # Only deploy on push to main

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: ./backend
        run: bun install

      # Run D1 migrations before deploying
      - name: Run D1 migrations
        working-directory: ./backend
        run: bunx wrangler d1 migrations apply typing-rpg-db --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # Deploy Worker to production
      - name: Deploy to Cloudflare Workers
        working-directory: ./backend
        run: bunx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
